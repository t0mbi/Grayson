<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grayson's Roblox Universe - Curriculum Conquest!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --font-primary: 'Press Start 2P', cursive; /* Pixel/Game font */
            --font-secondary: 'Inter', sans-serif; /* Readable text */
            
            /* Roblox-inspired Palette */
            --color-roblox-bg-dark: #23272A; 
            --color-roblox-bg-medium: #2C2F33; 
            --color-roblox-container-bg: #36393F; 
            --color-roblox-text-light: #FFFFFF; 
            --color-roblox-text-secondary: #B9BBBE; 
            
            --color-roblox-blue: #00A2FF; 
            --color-roblox-green: #00B06F; 
            --color-roblox-yellow: #FFCD00; 
            --color-roblox-red: #F04747;   
            --color-roblox-purple: #7289DA; 
            --color-roblox-orange: #F47B20; 
            --color-roblox-cyan: #00C2D1;
            --color-roblox-magenta: #E91E63; /* For Arts */
            --color-roblox-lime: #A4E820; /* For Science */
            --color-roblox-teal: #1ABC9C; /* For HPE */
            
            --color-border: #4F545C; 

            --color-progress-bar: var(--color-roblox-green);
            --color-progress-bar-bg: #202225; 
            --color-button-primary-bg: var(--color-roblox-blue);
            --color-button-primary-hover: #0082cc;
            --color-reset-bg: var(--color-roblox-red);
            --color-reset-hover-bg: #c83c3c;
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--color-roblox-bg-dark) 0%, var(--color-roblox-bg-medium) 100%);
            color: var(--color-roblox-text-light);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .page-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .view-container .container-content {
            background-color: var(--color-roblox-container-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 0 0 2px var(--color-border), 0 4px 10px rgba(0,0,0,0.25);
            text-align: center;
            width: 100%;
            margin-top: 1rem;
            border: 2px solid var(--color-border);
        }

        #dashboard-view h1, #week-submenu-view h1.view-title {
            color: var(--color-roblox-yellow);
            margin-bottom: 1rem;
            font-size: 1.5rem; /* Adjusted for pixel font */
            text-shadow: 2px 2px #000000;
        }
         #week-submenu-view p.view-subtitle {
            font-family: var(--font-secondary);
            font-size: 1rem;
            color: var(--color-roblox-text-secondary);
            margin-bottom: 1.5rem;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .item-card {
            background-color: var(--color-roblox-bg-medium);
            border-radius: 6px;
            padding: 1rem;
            box-shadow: inset 0 0 0 1px var(--color-border), 3px 3px 0px var(--color-roblox-bg-dark);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--color-border);
            cursor: pointer;
            min-height: 230px;
        }
        .item-card:hover {
            transform: translateY(-3px) translateX(-1px);
            box-shadow: inset 0 0 0 1px var(--color-roblox-yellow), 5px 5px 0px var(--color-roblox-bg-dark);
        }
        .item-card .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .item-card h2 { font-size: 0.8rem; color: var(--color-roblox-text-light); margin-bottom: 0.5rem; line-height: 1.3; }
        .item-card p.description { font-family: var(--font-secondary); font-size: 0.75rem; color: var(--color-roblox-text-secondary); text-align: center; margin-bottom: 0.75rem; flex-grow: 1; }

        .progress-bar-container { width: 90%; background-color: var(--color-progress-bar-bg); border-radius: 3px; height: 20px; margin-top: auto; overflow: hidden; position: relative; border: 1px solid var(--color-border); }
        .progress-bar-fill { background-color: var(--color-progress-bar); height: 100%; border-radius: 2px 0 0 2px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .progress-bar-text { font-family: var(--font-primary); font-size: 0.55rem; color: #000000; position: absolute; width: 100%; text-align: center; line-height: 20px; text-shadow: 1px 1px var(--color-roblox-text-light); }

        .reset-lesson-btn { font-family: var(--font-primary); font-size: 0.55rem; padding: 0.35rem 0.7rem; background-color: var(--color-reset-bg); color: var(--color-roblox-text-light); border: 1px solid var(--color-border); border-radius: 3px; cursor: pointer; margin-top: 0.75rem; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 2px 2px 0px var(--color-roblox-bg-dark); }
        .reset-lesson-btn:hover { background-color: var(--color-reset-hover-bg); transform: translateY(-1px) translateX(-1px); box-shadow: 3px 3px 0px var(--color-roblox-bg-dark); }
        .reset-lesson-btn:active { transform: translateY(1px) translateX(1px); box-shadow: 1px 1px 0px var(--color-roblox-bg-dark); }

        /* Card Color Accents & Icons */
        .card-color-1 { border-left: 5px solid var(--color-roblox-blue); } .card-color-1 .icon { color: var(--color-roblox-blue); }
        .card-color-2 { border-left: 5px solid var(--color-roblox-green); } .card-color-2 .icon { color: var(--color-roblox-green); }
        .card-color-3 { border-left: 5px solid var(--color-roblox-yellow); } .card-color-3 .icon { color: var(--color-roblox-yellow); }
        .card-color-4 { border-left: 5px solid var(--color-roblox-purple); } .card-color-4 .icon { color: var(--color-roblox-purple); }
        .card-color-5 { border-left: 5px solid var(--color-roblox-orange); } .card-color-5 .icon { color: var(--color-roblox-orange); }
        .card-color-6 { border-left: 5px solid var(--color-roblox-cyan); } .card-color-6 .icon { color: var(--color-roblox-cyan); }
        .card-color-7 { border-left: 5px solid var(--color-roblox-magenta); } .card-color-7 .icon { color: var(--color-roblox-magenta); }
        .card-color-8 { border-left: 5px solid var(--color-roblox-lime); } .card-color-8 .icon { color: var(--color-roblox-lime); }
        .card-color-9 { border-left: 5px solid var(--color-roblox-teal); } .card-color-9 .icon { color: var(--color-roblox-teal); }
        .card-color-10 { border-left: 5px solid #607D8B; } .card-color-10 .icon { color: #607D8B; } /* Blue Grey for Arts */


        /* Activity Page Styles */
        #activity-page-wrapper .container-content { background-color: var(--color-roblox-container-bg); border: 2px solid var(--color-border); }
        #activity-page-wrapper h1#week-main-title { color: var(--color-roblox-yellow); margin-bottom: 1rem; font-size: 1.3rem; text-shadow: 2px 2px #000000; }
        .week-title { font-size: 1.1rem; color: var(--color-roblox-green); margin-bottom: 1rem; }
        .lesson-intro { font-family: var(--font-secondary); font-size: 0.9rem; color: var(--color-roblox-text-light); margin-bottom: 1.5rem; text-align: left; padding: 0 0.5rem; }
        
        .sentence-context-display {
            font-family: var(--font-secondary);
            font-size: 0.9rem;
            color: var(--color-roblox-text-light);
            margin-bottom: 1rem;
            text-align: left;
            padding: 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-roblox-bg-medium);
            line-height: 1.7; 
        }

        .visual-question { font-size: 2rem; margin-bottom: 1rem; min-height: 2em; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 0.5rem; color: var(--color-roblox-blue); }
        .question { font-family: var(--font-primary); font-size: 0.8rem; line-height: 1.4; margin-bottom: 0.5rem; color: var(--color-roblox-text-light); min-height: 1.2em; }
        
        .choices-container {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            text-align: left;
            padding-left: 15%; 
        }
        .choice-item {
            font-family: var(--font-secondary); 
            font-size: 0.9rem; 
            color: var(--color-roblox-text-light);
            margin-bottom: 0.4rem;
            line-height: 1.5;
        }

        input[type="number"] { font-family: var(--font-primary); font-size: 1.3rem; padding: 0.4rem; border: 2px solid var(--color-border); border-radius: 3px; width: 60%; max-width: 150px; text-align: center; margin-bottom: 1.5rem; outline: none; background-color: var(--color-roblox-bg-medium); color: var(--color-roblox-text-light); box-shadow: inset 1px 1px 2px #000000; }
        input[type="number"]:focus { border-color: var(--color-roblox-yellow); box-shadow: inset 1px 1px 2px #000000, 0 0 3px var(--color-roblox-yellow); }

        #activity-page-wrapper button, .view-container button.nav-button { background-color: var(--color-button-primary-bg); color: var(--color-roblox-text-light); font-size: 0.8rem; padding: 0.7rem 1.1rem; border: 2px solid var(--color-border); border-radius: 3px; font-family: var(--font-primary); margin-top: 1rem; box-shadow: 2px 2px 0px var(--color-roblox-bg-dark); text-shadow: 1px 1px #000000; }
        #activity-page-wrapper button:hover, .view-container button.nav-button:hover { background-color: var(--color-button-primary-hover); transform: translateY(-1px) translateX(-1px); box-shadow: 3px 3px 0px var(--color-roblox-bg-dark); }
        #activity-page-wrapper button:active, .view-container button.nav-button:active { transform: translateY(1px) translateX(1px); box-shadow: 1px 1px 0px var(--color-roblox-bg-dark); }

        .feedback { font-size: 0.9rem; margin-top: 1rem; min-height: 1.5em; }
        .correct { color: var(--color-roblox-green); text-shadow: 1px 1px #000; }
        .incorrect { color: var(--color-roblox-red); text-shadow: 1px 1px #000; }
        .back-button { position: fixed; top: 0.5rem; left: 0.5rem; background-color: var(--color-button-primary-bg); color: var(--color-roblox-text-light); font-size: 0.9rem; width: 32px; height: 32px; display: flex; justify-content: center; align-items: center; border: 2px solid var(--color-border); border-radius: 3px; box-shadow: 2px 2px 0px var(--color-roblox-bg-dark); z-index: 1000; }
        .back-button:hover { background-color: var(--color-button-primary-hover); transform: translateY(-1px) translateX(-1px); box-shadow: 3px 3px 0px var(--color-roblox-bg-dark);}
        .back-button:active {transform: translateY(1px) translateX(1px); box-shadow: 1px 1px 0px var(--color-roblox-bg-dark);}

        .view-container { display: none; width:100%; }
        .view-container.active { display: block; }

        /* QR Code Styling */
        #qr-code-section {
            margin-top: 2rem;
            padding: 1rem;
            background-color: var(--color-roblox-bg-medium);
            border: 2px solid var(--color-border);
            border-radius: 6px;
            text-align: center;
        }
        #qr-code-section h3 {
            font-size: 0.9rem;
            color: var(--color-roblox-yellow);
            margin-bottom: 0.75rem;
        }
        #qr-code-canvas {
            background-color: white; /* QR codes need a white background to scan properly */
            padding: 5px; /* Small padding around the QR code itself */
            border-radius: 4px;
            display: inline-block; /* To center it if needed */
        }
        #qr-code-section p {
            font-family: var(--font-secondary);
            font-size: 0.7rem;
            color: var(--color-roblox-text-secondary);
            margin-top: 0.5rem;
        }

    </style>
</head>
<body>
    <div class="page-container">
        <div id="dashboard-view" class="view-container active">
            <div class="container-content">
                <h1>Grayson's Roblox Universe - Curriculum Conquest!</h1>
                <p class="mb-6" style="font-family: var(--font-secondary); font-size:1rem; color: var(--color-roblox-text-secondary);">Welcome, Grayson! Choose a world and conquer the challenges!</p>
                <div id="dashboard-grid" class="item-grid">
                    </div>
                <div id="qr-code-section">
                    <h3>Scan to Play on Another Device!</h3>
                    <canvas id="qr-code-canvas"></canvas>
                    <p>Note: In this preview, the QR code links to this specific session. If you save and host this HTML file, it will link to that hosted page.</p>
                </div>
            </div>
        </div>

        <div id="week-submenu-view" class="view-container">
            <button class="back-button" onclick="showDashboardView()" aria-label="Back to Dashboard">
                <i class="fas fa-map"></i>
            </button>
            <div class="container-content">
                <h1 id="submenu-title" class="view-title">World Levels</h1>
                <p id="submenu-intro" class="view-subtitle">Select a level to begin your adventure.</p>
                <div id="lesson-grid" class="item-grid">
                    </div>
            </div>
        </div>

        <div id="activity-page-wrapper" class="view-container">
            <button class="back-button" id="back-to-submenu-button" aria-label="Back to Levels">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="container-content" id="activity-content-holder">
                <h1 id="week-main-title">Challenge Zone</h1>
                <div id="week-theme-title" class="week-title"></div>
                <div id="lesson-intro" class="lesson-intro"></div>
                <div id="sentence-context-display" class="sentence-context-display" style="display: none;"></div> 
                <div id="visual-question" class="visual-question"></div>
                <div id="question" class="question"></div>
                <div id="choices-container" class="choices-container" style="display: none;"></div> 
                <input type="number" id="answer" placeholder="Answer?">
                <button id="check-button">Submit!</button>
                <div id="feedback" class="feedback"></div>
                <div id="completion-message" style="display: none;">
                    <h2 id="completion-week-title" class="week-title">Level Cleared! GG!</h2>
                    <p id="completion-lesson-intro" class="lesson-intro">You aced this level, Grayson! Amazing skills!</p>
                    <button id="completion-back-button" class="nav-button">Choose Next Level!</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const dashboardView = document.getElementById('dashboard-view');
        const dashboardGrid = document.getElementById('dashboard-grid');
        const weekSubmenuView = document.getElementById('week-submenu-view');
        const submenuTitle = document.getElementById('submenu-title');
        const submenuIntro = document.getElementById('submenu-intro');
        const lessonGrid = document.getElementById('lesson-grid');
        const activityPageWrapper = document.getElementById('activity-page-wrapper');

        let weekMainTitle, weekThemeTitle, lessonIntroDiv, visualQuestionDiv, questionDiv, answerInput, checkButton, feedbackDiv, completionMessageDiv, completionWeekTitle, completionLessonIntro, activityBackButton, completionBackButton, choicesContainer, sentenceContextDisplay;
        let qrCodeGenerated = false; // Flag to ensure QR code is generated only once

        let currentTopic = 1; // World
        let currentLesson = 1; // Level (1, 2, or 3) - used for difficulty scaling
        let questionIndex = 0;
        const questionsPerLesson = 20;
        const lessonsPerTopic = 3;
        let weeklyQuestions = [];
        let correctAnswer;

        const topicContent = { // Worlds
            1: { // Math - Multiplication & Division
                mainTitle: "Obby Runner's Math Dash", icon: "fas fa-person-running", colorClass: "card-color-1",
                lessons: [
                    { title: "Stud Multiplier Sprint", intro: "Collect studs in the obby, Grayson! Multiply to count your total haul.", questionTypes: Array(questionsPerLesson).fill('roblox_multiplication') },
                    { title: "Checkpoint Division Dash", intro: "You reached checkpoints! Divide your total time by checkpoints to find average time per stage.", questionTypes: Array(questionsPerLesson).fill('roblox_division') },
                    { title: "Obby Master Puzzles", intro: "Solve these tricky math puzzles to complete the ultimate obby and get the badge!", questionTypes: Array(questionsPerLesson).fill('roblox_word_problem_multi_div') }
                ]
            },
            2: { // Math - Numbers & Operations
                mainTitle: "Tycoon Empire Builder", icon: "fas fa-industry", colorClass: "card-color-2",
                lessons: [
                    { title: "Robux Earnings", intro: "Your tycoon is making Robux! Add up your earnings from different droppers.", questionTypes: Array(questionsPerLesson).fill('roblox_multi_digit_addition') },
                    { title: "Upgrade Costs", intro: "Buy new machines for your tycoon! Subtract the cost from your Robux balance.", questionTypes: Array(questionsPerLesson).fill('roblox_multi_digit_subtraction') },
                    { title: "Resource Round-Up", intro: "Estimate your cash or resources to plan your next big tycoon upgrade!", questionTypes: Array(Math.ceil(questionsPerLesson / 2)).fill('roblox_rounding_tens').concat(Array(Math.floor(questionsPerLesson / 2)).fill('roblox_rounding_hundreds')) }
                ]
            },
            3: { // Math - Fractions
                mainTitle: "Avatar Creator's Studio", icon: "fas fa-palette", colorClass: "card-color-3",
                lessons: [
                    { title: "Outfit Fractions", intro: "What fraction of your avatar's new outfit is using a cool hat, Grayson?", questionTypes: Array(questionsPerLesson).fill('roblox_fraction_identification') },
                    { title: "Mixing Accessories", intro: "Combine fractional parts of different accessory sets to create a unique look!", questionTypes: Array(questionsPerLesson).fill('roblox_fraction_add_subtract_like_denominators') },
                    { title: "Rarest Item?", intro: "Compare the rarity (fractions) of items. Which one is more unique?", questionTypes: Array(questionsPerLesson).fill('roblox_fraction_comparison') }
                ]
            },
            4: { // Math - Measurement & Geometry
                mainTitle: "Game Dev Workshop", icon: "fas fa-cogs", colorClass: "card-color-4",
                lessons: [
                    { title: "Scripting Blocks (Sides)", intro: "How many sides do these basic building parts in your game script have?", questionTypes: Array(questionsPerLesson).fill('roblox_shape_sides_2d') },
                    { title: "Map Border (Perimeter)", intro: "Calculate the perimeter of your new game map to set up the boundaries.", questionTypes: Array(questionsPerLesson).fill('roblox_perimeter_rectangle') },
                    { title: "Plot Size (Area)", intro: "Find the area of a player's plot in your building game.", questionTypes: Array(questionsPerLesson).fill('roblox_area_rectangle') }
                ]
            },
            5: { // English - Language & Literacy
                mainTitle: "Word Executor's Arena", icon: "fas fa-spell-check", colorClass: "card-color-5",
                lessons: [
                    { title: "Sentence Structure Blox", intro: "Game commands need clear structure! Identify the key parts in the sentence shown.", questionTypes: Array(questionsPerLesson).fill('english_identify_pos_from_sentence_display') },
                    { title: "Punctuation & Text Types", intro: "Understand game chat and info panels! What's the purpose of this message?", questionTypes: Array(questionsPerLesson).fill('english_sentence_type_numeric') },
                    { title: "Figurative Language Hunt", intro: "Game stories use cool language! What does this phrase *really* mean?", questionTypes: Array(questionsPerLesson).fill('english_figurative_lang_numeric') }
                ]
            },
            6: { // HASS - History & Geography
                mainTitle: "HASS Quest: Time & Place Explorers", icon: "fas fa-globe-americas", colorClass: "card-color-6",
                lessons: [
                    { title: "Mapping Ancient Robloxia", intro: "Explore old maps of Robloxia. Use directions and understand land connections.", questionTypes: Array(questionsPerLesson).fill('hass_map_skills_directions') },
                    { title: "Explorer's Voyage Calculations", intro: "Follow famous Roblox explorers. Calculate voyage durations and discovery dates.", questionTypes: Array(questionsPerLesson).fill('hass_timeline_voyages') },
                    { title: "Sustainable Server Management", intro: "Manage resources for your game server to keep it running for all players!", questionTypes: Array(questionsPerLesson).fill('hass_sustainability_management') }
                ]
            },
            7: { // Technologies - Digital & Design
                mainTitle: "Tech Creators' Lab", icon: "fas fa-laptop-code", colorClass: "card-color-7",
                lessons: [
                    { title: "Basic Algorithm Builder", intro: "Design simple scripts for your Roblox game. What's the correct order or missing step?", questionTypes: Array(questionsPerLesson).fill('tech_algorithm_sequence') },
                    { title: "Data & Digital Systems", intro: "How do games store info like scores or if a door is open/closed? Explore simple data.", questionTypes: Array(questionsPerLesson).fill('tech_data_representation_simple') },
                    { title: "Design & Materials Challenge", intro: "Choose the best materials for your Roblox builds based on their properties (like strength or weight).", questionTypes: Array(questionsPerLesson).fill('tech_design_materials_choice') }
                ]
            },
            8: { // Science
                mainTitle: "Science Lab Escape!", icon: "fas fa-atom", colorClass: "card-color-8",
                lessons: [
                    { title: "Life Cycle Labyrinth", intro: "Your Roblox pet blobfish just laid eggs! How many stages in its life cycle if it goes Egg -> Larva -> Adult? (Enter number)", questionTypes: Array(questionsPerLesson).fill('science_lifecycle_stages') },
                    { title: "Material Meltdown", intro: "You have a block of ice in your game. If it melts, it becomes water. Is this a reversible change? (1 for Yes, 0 for No)", questionTypes: Array(questionsPerLesson).fill('science_material_change_reversible') },
                    { title: "Force & Earth Shapers", intro: "A giant fan pushes your avatar in an obby. Is this a push (1) or a pull (2) force?", questionTypes: Array(questionsPerLesson).fill('science_force_type') }
                ]
            },
            9: { // HPE
                mainTitle: "Health & Movement Obby Run!", icon: "fas fa-heartbeat", colorClass: "card-color-9",
                lessons: [
                    { title: "Healthy Habits Hub", intro: "To keep your avatar's energy high for an obby, which is a better snack? 1. Energy Drink 2. Pixelated Apple", questionTypes: Array(questionsPerLesson).fill('hpe_healthy_choice_numeric') },
                    { title: "Epic Movement Trials", intro: "To cross a wide gap in an obby, you need to perform a long jump. This requires how many main leg movements? (e.g., Bend, Push, Extend = 3)", questionTypes: Array(questionsPerLesson).fill('hpe_movement_skill_count') },
                    { title: "Team Tactics & Fair Play Arena", intro: "In a team game, if your team has 4 players and the other has 3, is it fair? (0 for No, 1 for Yes)", questionTypes: Array(questionsPerLesson).fill('hpe_fair_play_numeric') }
                ]
            },
            10: { // The Arts - Visual Arts
                mainTitle: "Creative Canvas Studio!", icon: "fas fa-paint-brush", colorClass: "card-color-10",
                lessons: [
                    { title: "Elements of Art Blox", intro: "Look at this Roblox shirt design: 🟥🟦🟥. How many blue (🟦) shapes are there?", questionTypes: Array(questionsPerLesson).fill('arts_count_specific_element') },
                    { title: "Art Tools & Techniques Tycoon", intro: "To make a pixel art avatar, which tool is best? 1. Spray Can 2. Pixel Brush 3. Blur Tool", questionTypes: Array(questionsPerLesson).fill('arts_tool_choice_numeric') },
                    { title: "Masterpiece Meaning Quest", intro: "A game scene shows a dark cave with one torch. What feeling does it create? 1. Happy 2. Mysterious 3. Angry", questionTypes: Array(questionsPerLesson).fill('arts_artwork_meaning_numeric') }
                ]
            }
        };

        function initActivityPageDOMElements() {
            if (weekMainTitle) return;
            weekMainTitle = document.getElementById('week-main-title');
            weekThemeTitle = document.getElementById('week-theme-title');
            lessonIntroDiv = document.getElementById('lesson-intro');
            sentenceContextDisplay = document.getElementById('sentence-context-display'); 
            visualQuestionDiv = document.getElementById('visual-question');
            questionDiv = document.getElementById('question');
            choicesContainer = document.getElementById('choices-container');
            answerInput = document.getElementById('answer');
            checkButton = document.getElementById('check-button');
            feedbackDiv = document.getElementById('feedback');
            completionMessageDiv = document.getElementById('completion-message');
            completionWeekTitle = document.getElementById('completion-week-title');
            completionLessonIntro = document.getElementById('completion-lesson-intro');
            activityBackButton = document.getElementById('back-to-submenu-button');
            completionBackButton = document.getElementById('completion-back-button');

            checkButton.addEventListener('click', checkAnswer);
            answerInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); checkAnswer(); } });
            activityBackButton.onclick = () => showWeekSubmenuView(currentTopic);
            completionBackButton.onclick = () => showWeekSubmenuView(currentTopic);
        }

        function setActiveView(viewId) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0,0);
        }

        function showDashboardView() {
            populateDashboard();
            setActiveView('dashboard-view');
            if (!qrCodeGenerated) { // Generate QR code only once when dashboard is first shown
                generateQRCode();
                qrCodeGenerated = true;
            }
        }
        
        function generateQRCode() {
            try {
                const qrCanvas = document.getElementById('qr-code-canvas');
                if (qrCanvas && typeof QRious !== 'undefined') {
                    new QRious({
                        element: qrCanvas,
                        value: window.location.href,
                        size: 120, // Adjusted size
                        level: 'M', // Medium error correction
                        foreground: 'black', // Standard QR colors
                        background: 'white'
                    });
                } else {
                    console.warn("QRious library not found or canvas element missing.");
                    const qrSection = document.getElementById('qr-code-section');
                    if(qrSection) qrSection.innerHTML += "<p>QR Code could not be generated.</p>";
                }
            } catch (e) {
                console.error("Error generating QR code:", e);
                 const qrSection = document.getElementById('qr-code-section');
                 if(qrSection) qrSection.innerHTML += "<p>Error generating QR code.</p>";
            }
        }


        function populateDashboard() {
            dashboardGrid.innerHTML = '';
            Object.keys(topicContent).forEach((topicId, index) => {
                const topic = topicContent[topicId];
                const { overallProgress, lessonsStartedCount } = getTopicProgress(topicId);
                const progressPercent = ((overallProgress / (lessonsPerTopic * questionsPerLesson)) * 100).toFixed(0);
                const cardColorClass = topic.colorClass || `card-color-${(index % 10) + 1}`;


                const card = document.createElement('div');
                card.className = `item-card ${cardColorClass}`;
                card.onclick = () => showWeekSubmenuView(topicId);
                card.innerHTML = `
                    <div class="icon"><i class="${topic.icon}"></i></div>
                    <h2>World ${topicId}: ${topic.mainTitle}</h2>
                    <p class="description">${lessonsStartedCount} of ${lessonsPerTopic} levels started.</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${progressPercent}%;"></div>
                        <div class="progress-bar-text">${progressPercent}% (${overallProgress}/${lessonsPerTopic * questionsPerLesson})</div>
                    </div>
                `;
                dashboardGrid.appendChild(card);
            });
        }

        function showWeekSubmenuView(topicId) {
            currentTopic = parseInt(topicId);
            const topic = topicContent[currentTopic];
            submenuTitle.textContent = `World ${currentTopic}: ${topic.mainTitle}`;
            submenuIntro.textContent = `Select a level to start, Grayson!`;
            populateLessonGrid(currentTopic);
            setActiveView('week-submenu-view');
        }

        function populateLessonGrid(topicId) {
            lessonGrid.innerHTML = '';
            const topic = topicContent[topicId];
            const baseCardColorClass = topic.colorClass || `card-color-${(parseInt(topicId) - 1 % 10) + 1}`;
            topic.lessons.forEach((lesson, index) => {
                const lessonId = index + 1;
                const { questionsCompleted, completed } = getLessonProgress(topicId, lessonId);
                const progressPercent = ((questionsCompleted / questionsPerLesson) * 100).toFixed(0);

                const card = document.createElement('div');
                card.onclick = () => showActivityView(topicId, lessonId);
                card.className = `item-card ${baseCardColorClass}`;
                card.innerHTML = `
                    <div class="icon"><i class="fas fa-door-open"></i></div>
                    <h2>Level ${lessonId}: ${lesson.title}</h2>
                    <p class="description">${lesson.intro.substring(0, 70)}...</p>
                     <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${progressPercent}%; background-color: ${completed ? 'var(--color-roblox-green)' : 'var(--color-roblox-blue)'};"></div>
                        <div class="progress-bar-text">${completed ? 'Cleared!' : progressPercent + '%'} (${questionsCompleted}/${questionsPerLesson})</div>
                    </div>
                    <button class="reset-lesson-btn" onclick="event.stopPropagation(); resetLessonProgress(${topicId}, ${lessonId});">Reset Level</button>
                `;
                lessonGrid.appendChild(card);
            });
        }
        
        function showActivityView(topicId, lessonId) {
            currentTopic = parseInt(topicId);
            currentLesson = parseInt(lessonId); 
            const lessonProg = getLessonProgress(currentTopic, currentLesson);
            questionIndex = lessonProg.completed ? 0 : lessonProg.questionsCompleted;
            if(lessonProg.completed && questionIndex === 0) {
                 updateLessonProgress(currentTopic, currentLesson, 0, false);
            }

            initActivityPageDOMElements();
            const topic = topicContent[currentTopic];
            const lesson = topic.lessons[currentLesson - 1];

            weekMainTitle.textContent = `World ${currentTopic} / Level ${currentLesson}`;
            weeklyQuestions = generateLessonQuestions(topicId, lessonId);

            if (questionIndex >= questionsPerLesson && weeklyQuestions.length > 0) {
                showLessonCompletionScreen(topic.mainTitle, lesson.title);
            } else {
                showLessonIntroScreen(lesson.title, lesson.intro);
            }
            setActiveView('activity-page-wrapper');
        }
        
        function showLessonIntroScreen(lessonTitle, introText) {
            weekThemeTitle.textContent = lessonTitle;
            lessonIntroDiv.innerHTML = `<p>${introText}</p><button class="nav-button" id="start-lesson-button">Start Level!</button>`;
            lessonIntroDiv.style.display = 'block';
            
            const startButton = document.getElementById('start-lesson-button');
            if(startButton) startButton.onclick = startLessonActivities;

            sentenceContextDisplay.style.display = 'none'; 
            visualQuestionDiv.style.display = 'none';
            questionDiv.style.display = 'none';
            choicesContainer.style.display = 'none'; 
            answerInput.style.display = 'none';
            checkButton.style.display = 'none';
            feedbackDiv.textContent = '';
            completionMessageDiv.style.display = 'none';
        }

        function startLessonActivities() {
            visualQuestionDiv.style.display = 'flex';
            questionDiv.style.display = 'block';
            answerInput.style.display = 'block';
            checkButton.style.display = 'block';
            lessonIntroDiv.style.display = 'none';
            displayQuestion();
        }

        function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } return array; }

        const questionGenerators = {
            // Roblox Math Questions (Worlds 1-4) 
            'roblox_multiplication': () => { const n1 = getRandomInt(currentLesson === 1 ? 2 : (currentLesson === 2 ? 4 : 6), currentLesson === 1 ? 10 : (currentLesson === 2 ? 12 : 15)); const n2 = getRandomInt(currentLesson === 1 ? 5 : (currentLesson === 2 ? 10 : 15), currentLesson === 1 ? 20 : (currentLesson === 2 ? 50 : 100)); return { text: `Grayson collects ${n1} stacks of studs. Each stack has ${n2} studs. Total studs?`, visual: `🧱 ${n1} × ${n2}`, answer: n1 * n2 }; },
            'roblox_division': () => { const divisor = getRandomInt(currentLesson === 1 ? 2 : (currentLesson === 2 ? 3 : 4), currentLesson === 1 ? 10 : (currentLesson === 2 ? 12 : 15)); const quotient = getRandomInt(currentLesson === 1 ? 5 : (currentLesson === 2 ? 8 : 10), currentLesson === 1 ? 20 : (currentLesson === 2 ? 30 : 50)); const dividend = divisor * quotient; return { text: `You have ${dividend} Robux to share among ${divisor} friends for a VIP server. Robux per friend?`, visual: `R$ ${dividend} ÷ ${divisor}`, answer: quotient }; },
            'roblox_word_problem_multi_div': () => { const n1 = getRandomInt(currentLesson === 1 ? 2 : 3, currentLesson === 1 ? 5 : 8); const n2 = getRandomInt(currentLesson === 1 ? 10 : 15, currentLesson === 1 ? 25 : (currentLesson === 2 ? 40 : 60)); const product = n1 * n2; const type = Math.random() < 0.5 ? 'mult' : 'div'; if (type === 'mult') { return { text: `Grayson crafts ${n1} game passes. Each pass sells for ${n2} Robux. Total Robux earned?`, visual: `🎟️ ${n1} × ${n2}`, answer: product }; } return { text: `Your obby has ${product} total jumps. If there are ${n1} stages, how many jumps per stage on average?`, visual: `🏃 ${product} ÷ ${n1}`, answer: n2 }; },
            'roblox_multi_digit_addition': () => { const n1 = getRandomInt(currentLesson === 1 ? 100 : (currentLesson === 2 ? 200 : 500), currentLesson === 1 ? 500 : (currentLesson === 2 ? 999 : 2000)); const n2 = getRandomInt(currentLesson === 1 ? 100 : (currentLesson === 2 ? 200 : 500), currentLesson === 1 ? 500 : (currentLesson === 2 ? 999 : 2000)); return { text: `Your tycoon made ${n1} cash. You got a bonus of ${n2} cash. Total cash?`, visual: `💸 ${n1} + ${n2}`, answer: n1 + n2 }; },
            'roblox_multi_digit_subtraction': () => { const n1 = getRandomInt(currentLesson === 1 ? 200 : (currentLesson === 2 ? 500 : 1000), currentLesson === 1 ? 999 : (currentLesson === 2 ? 2000 : 5000)); const n2 = getRandomInt(currentLesson === 1 ? 50 : (currentLesson === 2 ? 100 : 200), n1 - (currentLesson === 1 ? 20 : (currentLesson === 2 ? 50 : 100))); return { text: `You had ${n1} health. A boss hit you for ${n2} damage. Health left?`, visual: `❤️ ${n1} - ${n2}`, answer: n1 - n2 }; },
            'roblox_rounding_tens': () => { const n = getRandomInt(currentLesson === 1 ? 21 : 51, currentLesson === 1 ? 99 : (currentLesson === 2 ? 299 : 499)); const ans = Math.round(n / 10) * 10; return { text: `Your game character is ${n} studs tall. Round to the nearest ten studs.`, visual: `📏 ${n} ≈ ?0`, answer: ans }; },
            'roblox_rounding_hundreds': () => { const n = getRandomInt(currentLesson === 1 ? 101 : 201, currentLesson === 1 ? 999 : (currentLesson === 2 ? 1999 : 4999)); const ans = Math.round(n / 100) * 100; return { text: `Your game world has ${n} trees. Round to the nearest hundred trees.`, visual: `🌳 ${n} ≈ ?00`, answer: ans }; },
            'roblox_fraction_identification': () => { const den = [3,4,5,6,8,10][getRandomInt(0, currentLesson === 1 ? 2 : (currentLesson === 2 ? 3 : 5))]; const num = getRandomInt(1, den-1); let visual = 'Potion Level: '; for(let i=0; i<den; i++) { visual += (i < num) ? '🧪' : '▫️'; } return { text: `Your potion bottle is ${num} out of ${den} parts full. What's the TOP number of the fraction?`, visual: visual, answer: num }; },
            'roblox_fraction_add_subtract_like_denominators': () => { const den = [4,6,8,10,12][getRandomInt(0, currentLesson === 1 ? 2 : (currentLesson === 2 ? 3 : 4))]; let n1 = getRandomInt(1, den-1); let n2 = getRandomInt(1, den-1); const op = Math.random() < 0.5 ? '+' : '-'; let ans; if (op === '+') { if (n1 + n2 >= den) { n2 = getRandomInt(1, Math.max(1, den - n1 -1));} ans = n1 + n2; } else { if (n1 < n2) { const temp = n1; n1 = n2; n2 = temp; } ans = n1 - n2; if (ans <= 0 && n1===n2) {n2 = Math.max(0,n2-1); ans=n1-n2; if (ans <0) ans = 0;} else if (ans <=0 && n1 !== n2) {ans =1; n1 = n2+1;}} return { text: `Your avatar has ${n1}/${den} energy. A power-up gives ${op === '+' ? '' : 'takes '}${n2}/${den}. New energy top number?`, visual: `⚡ ${n1}/${den} ${op} ${n2}/${den}`, answer: ans }; },
            'roblox_fraction_comparison': () => { const denBase = currentLesson === 1 ? 4 : (currentLesson === 2 ? 8 : 12); const den1 = [denBase, denBase/2 > 1 ? denBase/2 : denBase, denBase+2][getRandomInt(0,2)]; const num1 = getRandomInt(1, den1-1); let den2 = [denBase, denBase/2 > 1 ? denBase/2 : denBase, denBase+2][getRandomInt(0,2)]; let num2 = getRandomInt(1, den2-1); while(num1/den1 === num2/den2 || den1 === 0 || den2 === 0) { den2 = [denBase, denBase/2 > 1 ? denBase/2 : denBase, denBase+2][getRandomInt(0,2)]; num2 = getRandomInt(1, den2-1); } const ans = (num1/den1) < (num2/den2) ? 0 : 1; return { text: `Is item A (rarity ${num1}/${den1}) (0 for LESS rare, 1 for MORE/EQUAL rare) than item B (rarity ${num2}/${den2})?`, visual: `✨ ${num1}/${den1} vs ${num2}/${den2}`, answer: ans}; },
            'roblox_shape_sides_2d': () => { const shapesL1 = [{n:'square block',s:4,v:'🧱'}, {n:'triangle wedge',s:3,v:'◤'}]; const shapesL2 = [{n:'rectangle door',s:4,v:'🚪'}, {n:'pentagon shield decal',s:5,v:'🛡️'}]; const shapesL3 = [{n:'hexagon floor tile',s:6,v:'<i class="fas fa-hexagon"></i>'}, {n:'octagon stop sign',s:8,v:'🛑'}]; const s = currentLesson === 1 ? shapesL1[getRandomInt(0,shapesL1.length-1)] : (currentLesson === 2 ? shapesL2[getRandomInt(0,shapesL2.length-1)] : shapesL3[getRandomInt(0,shapesL3.length-1)]); return { text: `How many sides does this Roblox ${s.n} have?`, visual: `<span style="font-size:2.5rem">${s.v}</span>`, answer: s.s }; },
            'roblox_perimeter_rectangle': () => { const l = getRandomInt(5 + currentLesson*2, 20 + currentLesson*10); const w = getRandomInt(4 + currentLesson, 15 + currentLesson*8); return { text: `Your Roblox game map is ${l} studs by ${w} studs. What's its perimeter?`, visual: `🗺️ L:${l}, W:${w}`, answer: 2*(l+w) }; },
            'roblox_area_rectangle': () => { const l = getRandomInt(5 + currentLesson*2, 15 + currentLesson*8); const w = getRandomInt(4 + currentLesson, 12 + currentLesson*5); return { text: `A flat building area in your game is ${l} studs long and ${w} studs wide. Area?`, visual: `🏞️ ${l}x${w}`, answer: l*w }; },

            // English - World 5
             'english_identify_pos_from_sentence_display': () => {
                const sentences = [
                    { displayHTML: "Grayson <br>(1) quickly <br>(2) built <br>(3) a <br>(4) cool <br>(5) fort.", targetType: "V", targetDisplay: "VERB (action word)", answer: 2 },
                    { displayHTML: "The <br>(1) red <br>(2) lava <br>(3) flowed <br>(4) slowly <br>(5) down.", targetType: "ADJ", targetDisplay: "ADJECTIVE (describing word)", answer: 1 },
                    { displayHTML: "A <br>(1) mysterious <br>(2) portal <br>(3) appeared <br>(4) near <br>(5) the exit.", targetType: "N", targetDisplay: "NOUN (thing/place)", answer: 2 },
                    { displayHTML: "Jump <br>(1) now <br>(2) carefully <br>(3) over <br>(4) the <br>(5) gap!",  targetType: "ADV", targetDisplay: "ADVERB (describes action)", answer: 2 }
                ];
                let qDataPool = sentences;
                if (currentLesson === 1) qDataPool = sentences.filter(s => s.targetType === "N" || s.targetType === "V");
                else if (currentLesson === 2) qDataPool = sentences.filter(s => s.targetType === "ADJ" || s.targetType === "V"); // Mix it up
                else qDataPool = sentences.filter(s => s.targetType === "ADV" || s.targetType === "N"); 
                if(qDataPool.length === 0) qDataPool = sentences; 

                const qData = qDataPool[getRandomInt(0, qDataPool.length - 1)];
                return { questionContextHTML: qData.displayHTML, text: `Which numbered word above is a ${qData.targetDisplay}? Enter the number.`, visual: `📝`, answer: qData.answer };
            },
            'english_sentence_type_numeric': () => {
                const sentences = [
                    {s: "You have earned 1000 Robux!", type: "statement", ans: 1},
                    {s: "Is this the way to the treasure island, Grayson?", type: "question", ans: 2},
                    {s: "Activate the portal to the next world!", type: "command", ans: 3},
                    {s: (currentLesson > 1 ? "That boss battle was incredibly tough, GG!" : "The new update looks cool."), type: "statement", ans: 1},
                    {s: (currentLesson > 1 ? "Can you trade me that legendary sword?" : "Do you have enough Robux?"), type: "question", ans: 2},
                    {s: (currentLesson > 1 ? "Don't step on the lava blocks, it's an instant KO!" : "Follow the path."), type: "command", ans: 3}
                ];
                const qData = sentences[getRandomInt(0, sentences.length-1)];
                const mainText = `Game message: "${qData.s}" What type of sentence is this?`;
                const choicesList = ["Statement (tells something)", "Question (asks something)", "Command (tells someone to do something)"];
                return { text: mainText, choices: choicesList, visual: `💬`, answer: qData.ans };
            },
            'english_figurative_lang_numeric': () => { 
                const examplesL1 = [ {s: "Grayson's avatar ran like a cheetah in the obby!", type: "simile", choices: ["He was slow", "He ran very fast", "He turned into a cheetah"], ans: 2} ];
                const examplesL2 = [ {s: "The new game world was a shining diamond.", type: "metaphor", choices: ["It was made of diamonds", "It was beautiful and valuable", "It was very small"], ans: 2}, {s: "That sword is as sharp as a laser beam!", type: "simile", choices: ["It's dull", "It's very sharp", "It shoots lasers"], ans: 2} ];
                const examplesL3 = [ {s: "The lag made the game a slideshow.", type: "metaphor", choices: ["It showed vacation photos", "It was very slow and choppy", "It was smooth"], ans: 2}, {s: "His new virtual pet was a bundle of pixelated joy.", type: "metaphor", choices: ["A sad pet", "A very happy pet", "A broken pet"], ans: 2} ];
                
                const qData = currentLesson === 1 ? examplesL1[getRandomInt(0, examplesL1.length-1)] : (currentLesson === 2 ? examplesL2[getRandomInt(0, examplesL2.length-1)] : examplesL3[getRandomInt(0, examplesL3.length-1)]);
                return { text: `Game description: "${qData.s}" This is a ${qData.type}. What does it best mean?`, choices: qData.choices, visual: `✨`, answer: qData.ans };
            },

            // HASS - World 6
            'hass_map_skills_directions': () => {
                const directions = ["North", "South", "East", "West"];
                const correctDirIndex = getRandomInt(0,3);
                const landmark = ["Volcano Lair", "Ancient Temple", "Crystal Trading Post", "Waterfall Obby Entrance"][getRandomInt(0,3)];
                const mainText = `On your Roblox game map, the ${landmark} is to the ${directions[correctDirIndex]}. Which option is ${directions[correctDirIndex]}?`;
                const choicesList = currentLesson === 1 ? directions.slice(0,2) : (currentLesson === 2 ? directions.slice(0,3) : directions); // Fewer options for L1
                const correctAnswerInChoices = choicesList.indexOf(directions[correctDirIndex]) + 1;
                if (correctAnswerInChoices === 0 && choicesList.length < 4) { 
                    choicesList[getRandomInt(0, choicesList.length-1)] = directions[correctDirIndex]; 
                    return { text: mainText, choices: choicesList, visual: `🧭`, answer: choicesList.indexOf(directions[correctDirIndex]) + 1 };
                }
                return { text: mainText, choices: choicesList, visual: `🧭`, answer: correctAnswerInChoices || (correctDirIndex + 1) };
            },
            'hass_timeline_voyages': () => {
                const startYear = getRandomInt(1600 + currentLesson * 30, 1800 - currentLesson * 10); 
                const duration = getRandomInt(currentLesson === 1 ? 2 : 3, currentLesson === 1 ? 5 : (currentLesson === 2 ? 15 : 30));
                const endYear = startYear + duration;
                const context = currentLesson === 3 ? " (This might have been a very long server event!)" : "";
                return { text: `Explorer 'Sir Reginald Blox' started his grand Robloxian voyage in the game year ${startYear}. His journey lasted ${duration} game years${context}. What year did his famous voyage end?`, visual: `🚢 ${startYear} + ${duration}Y`, answer: endYear };
            },
            'hass_sustainability_management': () => {
                const dailyUse = getRandomInt(5 + currentLesson*2, 10 + currentLesson*3); 
                const initialStock = dailyUse * getRandomInt(5 + currentLesson, 10 + currentLesson*2);
                const daysLast = Math.floor(initialStock / dailyUse);
                return { text: `Your Roblox space station's 'Life Support System' uses ${dailyUse} energy crystals daily. You currently have ${initialStock} crystals. For how many FULL days will the life support last?`, visual: `🔋 ${initialStock} ÷ ${dailyUse}`, answer: daysLast };
            },

            // Technologies - World 7
            'tech_algorithm_sequence': () => {
                const L1actions = shuffleArray(["Move to Gem", "Collect Gem", "Add to Score"]);
                const L2actions = shuffleArray(["Player presses Jump Button", "Check Stamina", "If Stamina > 5, Perform Jump", "Reduce Stamina"]);
                const L3actions = shuffleArray(["Enemy Spotted", "Aim Weapon", "Fire Projectile", "Check if Hit", "If Hit, Reduce Enemy HP"]);
                const actions = currentLesson === 1 ? L1actions.slice(0,3) : (currentLesson === 2 ? L2actions.slice(0,4) : L3actions.slice(0,getRandomInt(4,5)));
                const stepToIdentify = getRandomInt(1,actions.length);
                
                const contextHTML = actions.map((act, idx) => `${idx+1}. ${act}`).join('<br>');

                const correctChoiceNum = getRandomInt(1,3);
                const choices = [];
                for(let i=1; i<=3; i++){
                    if(i === correctChoiceNum){
                        choices.push(actions[stepToIdentify-1]);
                    } else {
                        let wrongAction;
                        do { wrongAction = actions[getRandomInt(0, actions.length-1)]; } while (wrongAction === actions[stepToIdentify-1] || choices.includes(wrongAction));
                        choices.push(wrongAction);
                    }
                }
                return { questionContextHTML: contextHTML, text: `What is logical step number ${stepToIdentify} in this process?`, choices: choices, visual: `�`, answer: correctChoiceNum };
            },
            'tech_data_representation_simple': () => {
                let qText, ans, choicesList = null;
                const scenario = getRandomInt(1, currentLesson === 1 ? 2: 3);
                if (scenario === 1) { 
                    qText = "If your Roblox game uses 1 for 'true' (like 'Shield Active') and 0 for 'false', what number means 'Shield Active'?"; 
                    ans=1; 
                } else if (scenario === 2) { 
                    qText = "A game leaderboard shows scores. Grayson: 1500, PlayerB: 2000, PlayerC: 1200. Who is 1st?"; 
                    ans=2; choicesList = ["Grayson", "PlayerB", "PlayerC"];
                } else { 
                    qText = "Your game avatar has 3 states for a power-up: OFF (0), CHARGING (1), READY (2). If it's READY, what's the data value?";
                    ans=2;
                }
                return { text: qText, choices: choicesList, visual: `💾`, answer: ans };
            },
            'tech_design_materials_choice': () => {
                const materialsL1 = [ {name: "Cardboard Box Fort", strength: 2, weight: 1}, {name: "Wood Plank Wall", strength: 4, weight: 3}];
                const materialsL2 = [ {name: "Stone Barricade", strength: 6, speedPenalty: 2}, {name: "Metal Shield", strength: 8, speedPenalty: 3}];
                const materialsL3 = [ {name: "Energy Barrier", defense: 10, energyCost: 5}, {name: "Obsidian Wall", defense: 12, energyCost: 8}];
                
                const currentMaterialsPool = currentLesson === 1 ? materialsL1 : (currentLesson === 2 ? materialsL2 : materialsL3);
                const selected = shuffleArray([...currentMaterialsPool]).slice(0,2); 
                selected.push({name: "Basic Dirt Block", strength: 1, weight: 2, speedPenalty: 1, defense:1, energyCost:1}); 
                const finalSelected = shuffleArray(selected).slice(0,3);

                const criteria = currentLesson === 1 ? "STRONGEST" : (currentLesson === 2 ? "STRONGEST (ignoring speed penalty)" : "HIGHEST DEFENSE");
                let best;
                if (currentLesson === 1 || currentLesson === 2) best = finalSelected.reduce((max, m) => m.strength > max.strength ? m : max, finalSelected[0]);
                else best = finalSelected.reduce((max, m) => m.defense > max.defense ? m : max, finalSelected[0]);
                
                const choicesList = finalSelected.map(m => `${m.name} (Str ${m.strength || m.defense || 0})`);
                return { text: `Which material is ${criteria} for your Roblox creation?`, choices: choicesList, visual: `🛠️`, answer: finalSelected.findIndex(s => s.name === best.name) + 1 };
            },

            // Science - World 8
            'science_lifecycle_stages': () => {
                const creatures = [
                    {name: "Blobfish Pet", stages: ["Egg", "Larva", "Adult"], count: 3},
                    {name: "Pixel Butterfly", stages: ["Egg", "Caterpillar", "Chrysalis", "Butterfly"], count: 4},
                    {name: "Robo-Frog", stages: ["Spawn Pod", "Tadpole Bot", "Frog Bot"], count: 3}
                ];
                const creature = creatures[getRandomInt(0, creatures.length-1)];
                let questionText = `Your Roblox ${creature.name} goes through these stages: ${creature.stages.join(' -> ')}. How many main stages is that?`;
                if (currentLesson > 1) { 
                    const extraStage = currentLesson === 2 ? " (not counting 'Baby' stage)" : " (including a 'Juvenile' stage before 'Adult')";
                    questionText = `Your Roblox ${creature.name} has a life cycle. If it goes ${creature.stages.join(' -> ')}${extraStage}, how many total stages are described?`;
                }
                return { text: questionText, visual: `🧬`, answer: creature.count + (currentLesson === 3 ? 1 : 0) };
            },
            'science_material_change_reversible': () => {
                const changes = [
                    {material: "Ice Block", change: "melts to Water", reversible: 1, visual: "🧊->💧"}, 
                    {material: "Wood Log", change: "burns to Ash in a campfire", reversible: 0, visual: "🪵->🔥"}, 
                    {material: "Sand Block", change: "is smelted into Glass Block", reversible: 0, visual: "🏖️->💎"},
                    {material: "Water Puddle", change: "freezes into Ice Block", reversible: 1, visual: "💧->🧊"}
                ];
                let changePool = changes;
                if (currentLesson === 1) changePool = changes.filter(c => c.reversible === 1); 
                else if (currentLesson === 2) changePool = changes.filter(c => c.reversible === 0); 
                const selectedChange = changePool[getRandomInt(0, changePool.length - 1)];
                return { text: `In your Roblox game, a ${selectedChange.material} ${selectedChange.change}. Is this change easily reversible in the game? (1 for Yes, 0 for No)`, visual: `${selectedChange.visual}`, answer: selectedChange.reversible };
            },
            'science_force_type': () => {
                const forces = [
                    {scenario: "A giant fan in an obby pushes your avatar forward.", type: "push", ans: 1, visual: "💨"},
                    {scenario: "A magnet tool pulls metal blocks towards your avatar.", type: "pull", ans: 2, visual: "🧲"},
                    {scenario: "Your avatar kicks a soccer ball across the field.", type: "push", ans: 1, visual: "⚽"},
                    {scenario: "A grappling hook pulls your avatar up a cliff.", type: "pull", ans: 2, visual: "🧗"}
                ];
                 let forcePool = forces;
                if (currentLesson === 1) forcePool = forces.filter(f => f.type === "push");
                else if (currentLesson === 2) forcePool = forces.filter(f => f.type === "pull");
                const selectedForce = forcePool[getRandomInt(0, forcePool.length - 1)];
                return { text: `${selectedForce.scenario} Is the main force a PUSH (1) or a PULL (2)?`, choices: ["Push", "Pull"], visual: `${selectedForce.visual}`, answer: selectedForce.ans };
            },

            // HPE - World 9
            'hpe_healthy_choice_numeric': () => {
                const choices = [
                    {q: "To get energy for a long obby, what's better?", o1: "Energy Drink (Quick burst)", o2: "Pixelated Banana (Sustained energy)", ans: 2, v: "🍌"},
                    {q: "After a tough game, what helps your avatar recover?", o1: "Resting in a safe zone", o2: "Immediately starting another hard level", ans: 1, v: "🛌"},
                    {q: "For good teamwork in a Roblox game, what's more important?", o1: "Getting all the glory", o2: "Communicating with your team", ans: 2, v: "🤝"}
                ];
                const selectedQ = choices[getRandomInt(0, choices.length - 1)];
                return { text: `${selectedQ.q}`, choices: [selectedQ.o1, selectedQ.o2], visual: `${selectedQ.v}`, answer: selectedQ.ans };
            },
            'hpe_movement_skill_count': () => {
                const movements = [
                    {activity: "a double jump in an obby", skills: ["Bend knees", "Push off (1st jump)", "Tuck legs", "Push off mid-air (2nd jump)"], count: 4, v: "🤸"},
                    {activity: "dodging a laser beam", skills: ["See laser", "Lean/Duck", "Shift weight"], count: 3, v: "⚡"},
                    {activity: "climbing a blocky ladder", skills: ["Reach up", "Grip rung", "Pull up", "Step up"], count: 4, v: "🪜"}
                ];
                const selectedMovement = movements[getRandomInt(0, movements.length - 1)];
                const introText = currentLesson > 1 ? `Consider these main actions for ${selectedMovement.activity}: ${selectedMovement.skills.slice(0, getRandomInt(2,selectedMovement.skills.length-1)).join(', ')}... and the rest. ` : "";
                return { text: `${introText}Approximately how many distinct key body actions/skills are involved in performing ${selectedMovement.activity} effectively?`, visual: `${selectedMovement.v}`, answer: selectedMovement.count };
            },
            'hpe_fair_play_numeric': () => {
                const scenarios = [
                    {s: "Using a glitch to get unlimited Robux in a game.", fair: 0, v: "🐞"}, 
                    {s: "Sharing a health potion with a teammate who is low on health.", fair: 1, v: "➕❤️"}, 
                    {s: "Blaming your team for losing even if you made mistakes.", fair: 0, v: "😠"},
                    {s: "Congratulating the other team when they win a close game.", fair: 1, v: "👍"}
                ];
                const selectedScenario = scenarios[getRandomInt(0, scenarios.length - 1)];
                return { text: `In a Roblox game: "${selectedScenario.s}" Is this an example of fair play/good sportsmanship? (0 for No, 1 for Yes)`, visual: `${selectedScenario.v}`, answer: selectedScenario.fair };
            },

            // Arts - World 10
            'arts_count_specific_element': () => {
                const designs = [
                    {d: "Avatar Shirt: 🟥🟦🟥🟦🟥", element: "blue (🟦) squares", count: 2, v: "👕"},
                    {d: "Game Map Border: 🌲🌲🌳🌲🌲🌳🌲", element: "broadleaf trees (🌳)", count: 2, v: "🗺️"},
                    {d: "Pixel Art Sword: ⬜⬛⬛⬜⬛⬛⬜ (Handle: ⬛⬛)", element: "black (⬛) pixels in the blade (not handle)", count: 3, v: "⚔️"}
                ];
                const selectedDesign = designs[getRandomInt(0, designs.length - 1)];
                const complexity = currentLesson === 1 ? 3 : (currentLesson === 2 ? 5 : 7); 
                const simplePattern = selectedDesign.d.split('').slice(0, complexity + getRandomInt(0,2)).join('');

                return { text: `Look at this Roblox design pattern: ${currentLesson > 1 ? selectedDesign.d : simplePattern}. How many ${selectedDesign.element} are there?`, visual: `${selectedDesign.v}`, answer: selectedDesign.count };
            },
            'arts_tool_choice_numeric': () => {
                const tasks = [
                    {task: "creating a smooth gradient background for a game's sky", tools: ["Pixel Pencil", "Gradient Tool", "Stamp Tool"], ans: 2, v: "🌅"},
                    {task: "designing a detailed, blocky texture for a castle wall", tools: ["Airbrush", "Pixel Grid Painter", "Smudge Tool"], ans: 2, v: "🏰"},
                    {task: "adding a repeating pattern of studs to an avatar's pants", tools: ["Freehand Draw", "Pattern Fill Tool", "Eraser"], ans: 2, v: "👖"}
                ];
                const selectedTask = tasks[getRandomInt(0, tasks.length - 1)];
                return { text: `For ${selectedTask.task} in a Roblox design program, which tool is most suitable?`, choices: selectedTask.tools, visual: `${selectedTask.v}`, answer: selectedTask.ans };
            },
            'arts_artwork_meaning_numeric': () => {
                const artworks = [
                    {desc: "A Roblox game thumbnail shows a dark, stormy sky over a crumbling castle.", feeling: "Mysterious/Gloomy", options: ["Joyful", "Mysterious/Gloomy", "Peaceful"], ans: 2, v: "⛈️🏰"},
                    {desc: "An avatar is wearing all bright yellow and orange clothes, jumping with a wide smile.", feeling: "Energetic/Happy", options: ["Sad", "Bored", "Energetic/Happy"], ans: 3, v: "😄"},
                    {desc: "A game lobby is decorated with soft blue lights and calm music is playing (implied).", feeling: "Calm/Relaxing", options: ["Chaotic", "Calm/Relaxing", "Scary"], ans: 2, v: "🛋️"}
                ];
                const selectedArt = artworks[getRandomInt(0, artworks.length - 1)];
                return { text: `Consider this Roblox scene: "${selectedArt.desc}" What feeling does this art primarily create?`, choices: selectedArt.options, visual: `${selectedArt.v}`, answer: selectedArt.ans };
            }
        };
        
        function generateLessonQuestions(topicId, lessonId) {
            const lesson = topicContent[topicId].lessons[lessonId - 1];
            if (!lesson) return [];
            const questions = lesson.questionTypes.map(type => {
                if (questionGenerators[type]) return questionGenerators[type]();
                console.warn(`Unknown question type: ${type}`);
                return { text: "Error: Glitch in the system! Question didn't load.", visual: "❓", answer: 0 };
            });
            return shuffleArray(questions);
        }

        function displayQuestion() {
            if (!weeklyQuestions || questionIndex >= weeklyQuestions.length) {
                showLessonCompletionScreen(topicContent[currentTopic].mainTitle, topicContent[currentTopic].lessons[currentLesson-1].title);
                return;
            }
            const q = weeklyQuestions[questionIndex];
            if (!q) {
                console.error("Question undefined at index: ", questionIndex, "for lesson:", currentTopic, currentLesson);
                feedbackDiv.textContent = 'Oops! A question block is missing!';
                feedbackDiv.className = 'feedback incorrect';
                setTimeout(() => showWeekSubmenuView(currentTopic), 2000);
                return;
            }

            sentenceContextDisplay.innerHTML = '';
            sentenceContextDisplay.style.display = 'none';
            choicesContainer.innerHTML = '';
            choicesContainer.style.display = 'none';

            if (q.questionContextHTML) {
                sentenceContextDisplay.innerHTML = q.questionContextHTML;
                sentenceContextDisplay.style.display = 'block';
            }
            
            if (q.choices && Array.isArray(q.choices)) {
                q.choices.forEach((choice, idx) => {
                    const choiceElement = document.createElement('p');
                    choiceElement.classList.add('choice-item');
                    choiceElement.textContent = `${idx + 1}. ${choice}`;
                    choicesContainer.appendChild(choiceElement);
                });
                choicesContainer.style.display = 'block';
            }

            questionDiv.textContent = q.text;
            visualQuestionDiv.innerHTML = q.visual;
            correctAnswer = q.answer;
            answerInput.value = '';
            feedbackDiv.textContent = '';
            answerInput.focus();
        }
        
        function showLessonCompletionScreen(topicTitle, lessonTitle) {
            completionWeekTitle.textContent = `Level Cleared: ${lessonTitle}`;
            completionLessonIntro.textContent = `GG, Grayson! You mastered ${topicTitle} - ${lessonTitle}.`;
            completionMessageDiv.style.display = 'block';
            visualQuestionDiv.style.display = 'none'; questionDiv.style.display = 'none';
            sentenceContextDisplay.style.display = 'none'; choicesContainer.style.display = 'none';
            answerInput.style.display = 'none'; checkButton.style.display = 'none';
            lessonIntroDiv.style.display = 'none'; feedbackDiv.textContent = '';
        }

        function checkAnswer() {
            if (weeklyQuestions.length === 0 || !weeklyQuestions[questionIndex]) {
                 feedbackDiv.textContent = 'No question loaded. Try restarting the level.';
                 feedbackDiv.className = 'feedback incorrect';
                 return;
            }
            const userAnswer = parseInt(answerInput.value, 10);
            if (isNaN(userAnswer)) {
                feedbackDiv.textContent = 'Enter a number, Gamer!';
                feedbackDiv.className = 'feedback incorrect'; return;
            }
            if (userAnswer === correctAnswer) {
                feedbackDiv.textContent = 'Correct! +100 Studs!';
                feedbackDiv.className = 'feedback correct';
                questionIndex++;
                updateLessonProgress(currentTopic, currentLesson, questionIndex, questionIndex >= questionsPerLesson);
                setTimeout(displayQuestion, 1500);
            } else {
                feedbackDiv.textContent = 'Oof! Try again, Grayson!';
                feedbackDiv.className = 'feedback incorrect';
            }
        }

        const progressStorageKey = 'graysonRobloxUniverseCurriculumV6'; // Key update for new content

        function loadProgressData() {
            const data = localStorage.getItem(progressStorageKey);
            return data ? JSON.parse(data) : {};
        }

        function saveProgressData(data) {
            localStorage.setItem(progressStorageKey, JSON.stringify(data));
        }

        function getLessonProgress(topicId, lessonId) {
            const progress = loadProgressData();
            return progress[topicId]?.lessons?.[lessonId] || { questionsCompleted: 0, completed: false };
        }

        function getTopicProgress(topicId) {
            const progress = loadProgressData();
            let overallProgress = 0;
            let lessonsStartedCount = 0;
            if (progress[topicId]?.lessons) {
                for (let i = 1; i <= lessonsPerTopic; i++) {
                    const lessonProg = progress[topicId].lessons[i];
                    if (lessonProg) {
                        overallProgress += lessonProg.questionsCompleted;
                        if (lessonProg.questionsCompleted > 0) lessonsStartedCount++; 
                    }
                }
            }
            return { overallProgress, lessonsStartedCount };
        }

        function updateLessonProgress(topicId, lessonId, qCompleted, isLessonDone) {
            const progress = loadProgressData();
            if (!progress[topicId]) progress[topicId] = { lessons: {} };
            if (!progress[topicId].lessons[lessonId]) progress[topicId].lessons[lessonId] = { questionsCompleted: 0, completed: false };

            progress[topicId].lessons[lessonId].questionsCompleted = Math.min(qCompleted, questionsPerLesson);
            progress[topicId].lessons[lessonId].completed = isLessonDone || (qCompleted >= questionsPerLesson);
            saveProgressData(progress);
        }

        function resetLessonProgress(topicId, lessonId) {
            updateLessonProgress(topicId, lessonId, 0, false);
            if(document.getElementById('week-submenu-view').classList.contains('active')) {
                 populateLessonGrid(topicId);
            }
        }

        window.onload = function() {
            initActivityPageDOMElements();
            showDashboardView();
        };
    </script>
</body>
</html>
�